# kubernetes-minikube-environment
## `> book-service-kong-keycloak`

The goal of this example is to run inside [`Kubernetes`](https://kubernetes.io) ([`Minikube`](https://github.com/kubernetes/minikube)): [`book-service`](https://github.com/ivangfr/springboot-kong-keycloak) [`Spring Boot`](https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/) application, [`Kong`](https://konghq.com) API Gateway and [`Keycloak`](https://www.keycloak.org) OpenID Connect Provider.

Once deployed in `Kubernetes` cluster, `book-service` will only be reachable through `Kong` API gateway.

In `Kong`, it's installed [`kong-oidc`](https://github.com/nokia/kong-oidc) plugin that will enable the communication between `Kong` and `Keycloak` OpenID Connect Provider.

This way, when `Kong` receives a request to `book-service`, it will validate together with `Keycloak` whether it's a valid request.

Also, before redirecting to the request to the upstream service, a `Serverless Function (post-function)` will get the access token present in the `X-Userinfo` header provided by `kong-oidc` plugin, decoded it, extracts the `username` and `preferred_username`, and enriches the request with these two information before sending to `book-service`

## Clone example repository

In a terminal, run the following command to clone [`springboot-kong-keycloak`](https://github.com/ivangfr/springboot-kong-keycloak)
```
git clone https://github.com/ivangfr/springboot-kong-keycloak.git
```

## Start Minikube

First, start `Minikube` as explained in [Start Minikube](https://github.com/ivangfr/kubernetes-minikube-environment#start-minikube)

## Build Docker Images

- In a terminal, navigate to `springboot-kong-keycloak` root folder

- Set `Minikube` host
  ```
  eval $(minikube docker-env)
  ```

- Build `book-service` Docker image. For it, run the following command
  ```
  ./docker-build.sh
  ```

- Build `Kong` Docker Image with `kong-oidc` plugin by running the command below
  ```
  docker build -t kong:2.8.1-oidc docker/kong
  ```
  
- Get back to Host machine Docker Daemon   
  ```
  eval $(minikube docker-env -u)
  ```

## Create a namespace

- In a terminal, run the following command to create a new namespace called `dev`
  ```
  kubectl create namespace dev
  ```
  > To delete run
  > ```
  > kubectl delete namespace dev
  > ```

- \[Optional\] To list all namespaces run
  ```
  kubectl get namespaces
  ```

## Install services

- In a terminal, make sure you are in `kubernetes-minikube-environment/book-service-kong-keycloak` folder

- To install the services, run the script below
  ```
  ./install-services.sh
  ```
  > To uninstall run
  > ```
  > ./uninstall-services.sh
  > ```

  It will install `MySQL`, `Postgres`, `MongoDB`, `Kong` and `Keycloak`. It can take some time (pulling docker images, starting services, etc).
  
- Watch the status/progress of the service's installation
  ```
  kubectl get pods --namespace dev --watch
  ```
  > To stop watching, press `Ctrl+C`

## Install book-service

- In a terminal, make sure you are in `kubernetes-minikube-environment/book-service-kong-keycloak` folder

- Run the command below to create a secret used by `book-service` to connect to `MongoDB`
  ```
  kubectl create secret --namespace dev generic book-service-db --from-literal=username=bookuser --from-literal=password=bookpass
  ```
  > To delete run
  > ```
  > kubectl delete secrets --namespace dev book-service-db
  > ```

- \[Optional\] To get more information about `book-service-db` secret run
  ```
  kubectl get secrets --namespace dev book-service-db -o yaml
  ```

- Install `book-service`
  ```
  kubectl apply --namespace dev --filename deployment-files/bookservice-deployment.yaml
  ```
  > To delete run
  > ```
  > kubectl delete --namespace dev --filename deployment-files/bookservice-deployment.yaml
  > ```

## Configure Keycloak

- In a terminal, make sure you are in `springboot-kong-keycloak` root folder

- Create `KEYCLOAK_HOST_PORT` environment variable
  ```
  KEYCLOAK_HOST_PORT="$(minikube ip):$(kubectl get services --namespace dev my-keycloak-keycloakx-http -o go-template='{{(index .spec.ports 0).nodePort}}')"
  ```
    
- Run the following script to configure `Keycloak` for `book-service` application
  ```
  ./init-keycloak.sh $KEYCLOAK_HOST_PORT
  ```

  This script creates:
  - `company-services` realm;
  - `book-service` client;
  - user with _username_ `ivan.franchin` and _password_ `123`.

- The `book-service` client secret (`BOOK_SERVICE_CLIENT_SECRET`) is shown at the end of the execution. It will be used in the next step

## Configure Kong

- In a terminal, make sure you are in `springboot-kong-keycloak` root folder

- Create an environment variable that contains the `Client Secret` generated by `Keycloak` to `book-service` at [Configure Keycloak](#Configure Keycloak) step
  ```
  BOOK_SERVICE_CLIENT_SECRET=...
  ```

- Create `KONG_ADMIN_HOST_PORT` environment variable
  ```
  KONG_ADMIN_HOST_PORT="$(minikube ip):$(kubectl get services --namespace dev my-kong-kong-admin -o go-template='{{(index .spec.ports 0).nodePort}}')"
  ```

- Run the following script to configure `Kong` for `book-service` application
  ```
  ./init-kong.sh $BOOK_SERVICE_CLIENT_SECRET $KONG_ADMIN_HOST_PORT "my-keycloak-keycloakx-http" "bookservice-service:9080"
  ```

  This script creates:
  - service to `book-service`;
  - route to `/actuator` path;
  - route to `/api` path;
  - add `kong-oidc` plugin to route of `/api` path. It will authenticate users against `Keycloak` OpenID Connect Provider;
  - add `serverless function (post-function)` plugin to route of `/api` path. It gets the access token present in the `X-Userinfo` header provided by `kong-oidc` plugin, decoded it, extracts the `username` and `preferred_username`, and enriches the request with these two information before sending to `book-service`.

## Testing

- In a terminal, make sure you are in `kubernetes-minikube-environment/book-service-kong-keycloak` folder

- Create `KONG_PROXY_HOST_PORT` environment variable
  ```
  KONG_PROXY_HOST_PORT="$(minikube ip):$(kubectl get services --namespace dev my-kong-kong-proxy -o go-template='{{(index .spec.ports 0).nodePort}}')"
  ```
  
- Create `BOOK_SERVICE_CLIENT_SECRET` environment variable that contains the `Client Secret` generated by `Keycloak` to `book-service` at [Configure Keycloak](#configure-keycloak)
  ```
  BOOK_SERVICE_CLIENT_SECRET=...
  ```

- Call `GET /actuator/health` endpoint
  ```
  curl -i http://$KONG_PROXY_HOST_PORT/actuator/health -H 'Host: book-service'
  ```
  It should return
  ```
  {"status":"UP","groups":["liveness","readiness"]}
  ```

- Call `GET /api/books` endpoint without access token
  ```
  curl -i http://$KONG_PROXY_HOST_PORT/api/books -H 'Host: book-service'
  ```
  It should return
  ```
  HTTP/1.1 401 Unauthorized
  no Authorization header found
  ```

- Get `ivan.franchin` access token
  ```
  ACCESS_TOKEN=$(./get-access-token.sh $BOOK_SERVICE_CLIENT_SECRET) && echo $ACCESS_TOKEN
  ```
  > **Tip:** In jwt.io, you can decode and verify the `JWT` access token

- Call `GET /api/books` endpoint informing the access token
  ```
  curl -i http://$KONG_PROXY_HOST_PORT/api/books -H 'Host: book-service' \
    -H "Authorization: Bearer $ACCESS_TOKEN"
  ```
  It should return
  ```
  HTTP/1.1 200
  []
  ```

- You can try other endpoints using access token

  Create book
  ```
  curl -i -X POST http://$KONG_PROXY_HOST_PORT/api/books -H 'Host: book-service' \
    -H "Authorization: Bearer $ACCESS_TOKEN" \
    -H "Content-Type: application/json" -d '{"isbn": "123", "title": "Kong & Keycloak"}'
  ```

  Get book
  ```
  curl -i http://$KONG_PROXY_HOST_PORT/api/books/123 -H 'Host: book-service' \
    -H "Authorization: Bearer $ACCESS_TOKEN"
  ```

  Delete book
  ```
  curl -i -X DELETE http://$KONG_PROXY_HOST_PORT/api/books/123 -H 'Host: book-service' \
    -H "Authorization: Bearer $ACCESS_TOKEN"
  ```

## Cleanup

- In a terminal, make sure you are in `kubernetes-minikube-environment/book-service-kong-keycloak` folder

- Run the script below to uninstall all services, `book-service` application and `dev` namespace.
  ```
  ./cleanup.sh
  ```
